<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW X5 2021 Reviews</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="header-links">
        <a href="index.html" class="header-link">Home</a>
        <a href="#" class="header-link" id="loginLink">Login</a>
        <a href="#" class="header-link" id="logoutLink" style="display: none;">Logout</a>
        <a href="#" class="header-link">About</a>
    </div>
    <h1 id="pageTitle">BMW X5 2021 Reviews</h1>

    <!-- Container to display reviews -->
    <div id="reviewsContainer" class="reviews-container">
        <h2>Reviews</h2>
        <div id="reviews-section"></div>

        <!-- Form to submit a new review -->
        <form id="reviewForm">
            <textarea id="reviewText" placeholder="Write your review here..." required></textarea>
            <button type="submit">Submit Review</button>
        </form>
    </div>

    <script>
        // Function to update the page title dynamically
        function updatePageTitle(carName) {
            document.title = `${carName} Reviews`;
            document.getElementById('pageTitle').innerText = `${carName} Reviews`;
        }

        // Function to update login status and UI
        async function updateLoginStatus() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const loginLink = document.getElementById('loginLink');
            const logoutLink = document.getElementById('logoutLink');

            if (loggedInUser) {
                loginLink.style.display = 'none';
                logoutLink.style.display = 'inline';
            } else {
                loginLink.style.display = 'inline';
                logoutLink.style.display = 'none';
            }
        }

        // Fetch reviews for the current car when the page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Extract car ID or name from the URL or any other source
            const queryParams = new URLSearchParams(window.location.search);
            const carId = queryParams.get('car_id'); // Example: ?car_id=123
            const carName = queryParams.get('car_name'); // Example: ?car_name=BMW X

            try {
                let response;
                if (carId) {
                    response = await fetch(`/reviews/${carId}`);
                } else if (carName) {
                    // If you're using car name instead of ID
                    response = await fetch(`/reviewsByName/${carName}`);
                }

                if (response.ok) {
                    const reviews = await response.json();
                    displayReviews(reviews);
                    // Update page title dynamically
                    updatePageTitle(carName);
                } else {
                    console.error('Failed to fetch reviews:', response.statusText);
                }
            } catch (error) {
                console.error('Error fetching reviews:', error.message);
            }
        });

        // Form submission event listener
        const reviewForm = document.getElementById('reviewForm');
        reviewForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const reviewText = document.getElementById('reviewText').value;

            // Extract car ID or name from the URL or any other source
            const queryParams = new URLSearchParams(window.location.search);
            const carId = queryParams.get('car_id');
            const carName = queryParams.get('car_name');

            try {
                const response = await fetch('/submit-review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        carId,
                        carName,
                        reviewText
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(result.message); // Log success message
                    // Optionally, fetch and display updated reviews
                } else {
                    console.error('Failed to submit review:', response.statusText);
                }
            } catch (error) {
                console.error('Error submitting review:', error.message);
            }
        });

        // Update login status when the page loads
        updateLoginStatus();
    </script>

</body>

</html>